FROM python:3.10-slim

# Set working directory
WORKDIR /app/backend

# Install Poetry
RUN apt-get update && apt-get install -y curl \
  && curl -sSL https://install.python-poetry.org | python3 - \
  && ln -s ~/.local/bin/poetry /usr/local/bin/poetry

# Disable Poetry virtualenvs
ENV POETRY_VIRTUALENVS_CREATE=false

# Copy only the lock and config files first for caching
COPY backend/pyproject.toml backend/poetry.lock* ./

# Install dependencies
RUN poetry install --no-root

# Copy the rest of the source code
COPY backend .

# Expose port and run the app
EXPOSE 8000
CMD ["poetry", "run", "uvicorn", "api:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
