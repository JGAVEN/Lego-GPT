# render.yaml  ── Blueprint: API + Redis + Static Site
services:
  # ────────────────────────────────────────────────
  - type: web
    name: lego-gpt-api-green
    runtime: python
    rootDir: .
    pythonVersion: 3.11
    buildCommand: pip install -e backend
    startCommand: uvicorn backend.api:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    autoDeploy: true
    branch: main
    plan: standard            # 2 GB RAM / 1 vCPU
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: lego-gpt-redis
          property: connectionString
      - key: JWT_SECRET        # removed “sync: false”
        value: ycQGGSqO3/JYGY96TLnC829sXFPHMW+OFIcx/OSL+gs=
      - key: RATE_LIMIT
        value: "10"
      - key: CORS_ORIGINS
        value: "http://localhost:5173,https://lego-gpt.onrender.com"

  - type: web
    name: lego-gpt-api-blue
    runtime: python
    rootDir: .
    pythonVersion: 3.11
    buildCommand: pip install -e backend
    startCommand: uvicorn backend.api:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    autoDeploy: false
    branch: main
    plan: standard
    envVars:
      - fromService:
          type: redis
          name: lego-gpt-redis
          property: connectionString
        key: REDIS_URL
      - key: JWT_SECRET
        value: ycQGGSqO3/JYGY96TLnC829sXFPHMW+OFIcx/OSL+gs=
      - key: RATE_LIMIT
        value: "10"
      - key: CORS_ORIGINS
        value: "http://localhost:5173,https://lego-gpt.onrender.com"

  # ────────────────────────────────────────────────
  - type: redis
    name: lego-gpt-redis
    plan: free                # Hobby plan – sleeps when idle
    ipAllowList:
      - source: 0.0.0.0/0
    maxmemoryPolicy: allkeys-lru

  # ────────────────────────────────────────────────
  - type: web                  # static site
    name: lego-gpt             # → https://lego-gpt.onrender.com
    runtime: static
    rootDir: frontend
    buildCommand: |
      pnpm install --no-frozen-lockfile
      pnpm run build
    envVars:
      - key: NODE_VERSION
        value: "20"
    staticPublishPath: dist
    branch: main
    autoDeploy: true
